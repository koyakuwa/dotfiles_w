x = [0 0 0 0 0 0 1 0 1 0 1 0]';
xd = [0 0 0 0 2 0 0 0 0 0 0 0]';
u = [0 0 0 0]';
k = [1 1 1 6 -5]';
Ix = 10;
Iy = 10;
Iz = 10;
m = 1;
JR = 1;
omega = 10;
dt = 0.001;
tf = 50;
xx = [];
d = [];
i = 0;
g = 9.81;
l = 1;

for t = 0:dt:tf
    i = i+1;
    xx(:,i) = x;
    xt = x;
    for j = 1:4
        u1h = (k(4) * x(5)) + (k(5) * x(6));
        u = [ ( m*g/( cos(x(7)) * cos(x(9)) ) ) + ( m*u1h/( cos(x(7)) * cos(x(9)) ));
        ( (-l/Ix) * ( x(7) - xd(7) ) - ( k(1) * x(8) ) );
        ( (-l/Iy) * ( x(9) - xd(9) ) - ( k(2) * x(10) ) );
        ( (-l/Iz) * ( x(11) - xd(11)) - (k(3) * x(12) ) )];
        f = [x(2);
             ( ( cos(x(7))*sin(x(9))*cos(x(11))+sin(x(7))*sin(x(11)) ) * u(1)/m );
             x(4);
             (( cos(x(7))*sin(x(9))*sin(x(11))-sin(x(7))*cos(x(11)) ) * u(1)/m );
             x(6);
             (-g +( cos(x(7)) * cos(x(9)) * u(1) / m ) );
             x(8);
             (x(12)*x(10)*( (Iy-Iz)/Ix ) - (JR/Ix)*x(10)*omega + (l/Ix)* ...
                 u(2));
             x(10);
             (x(12)*x(8)*( (Iz-Ix)/Iy ) - (JR/Iy)*x(10)*omega + (l/Iy)* ...
                 u(3));
             x(12);
             (x(10)*x(8)*( (Ix-Iy)/Iz ) + (l/Iz)*u(3) )];
        d(:,j) = f * dt;
        x = xt + d(:,j)*0.5;
        if j == 3
            x = xt + d(:,j);
        end
    end
    x = xt + (d(:,1) + d(:,2)*2 + d(:,3)*2 + d(:,4))/6;
end

grid on
t = 0:dt:tf;
subplot(2,2,1)
plot(t,xx(7,:))
subplot(2,2,2)
plot(t,xx(9,:))
subplot(2,2,3)
plot(t,xx(11,:))
subplot(2,2,4)
plot(t,xx(3,:))
