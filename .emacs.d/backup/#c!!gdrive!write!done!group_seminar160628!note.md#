# 研究動機

まず、研究動機について述べる。

## バッテリーと電動ビークル

近年のバッテリーの発展から、電動ビークルが普及し始めている。
1991年に世界で初めて製品化されたことリチウムイオン電池は
従来のニッカド電池やニッケル水素電池と比較して
高い電圧と高エネルギー密度を得ることができたため、
携帯やパソコンなど多くの製品で採用された。
図を見ると、リチウムイオン二次電池の高エネルギー密度の特徴が見て取れる。

![Energy Density of lithium ion battery\cite{baysan}](li-ion.png)

その後、さらなる大容量化の実現によって電気自動車など
実用的な電動ビークルに至るまで発展した。
日産LEAFが発売されたのは2010年である。

現代において、バッテリーはその利便性から至る所に利用されている。
バッテリーがもたらす利点は「エネルギーの貯蔵」と「コードレス化」である。
エネルギーを長時間保存できる機能から利用時間の自由が生まれ、
電源コードから解放されたために屋外などでどんな場所でも利用できるようになった。
この2つの機能・技術の応用として、電度ビークルの分野が存在する。
電動ビークルの利用環境は車や電車に代表される陸のみに限られず、
電気航空機（空）、船舶（海）や宇宙船（宇宙）にも及ぶ。

近年、盛んに研究されている無人航空機(UAV)も電動ビークルに含まれる。
UAVの発展のきっかけにリチウムイオン電池の発明が大きく関与していることは明白である。
2013年には米Amazon社がUAVによる宅配便が発表されている。

## 電動ビークルの現状と課題

次に電動ビークルの現状と課題を紹介する。
電動ビークルの最大の課題は航続距離にあるといえる。
図に現状の電気自動車・ハイブリッド自動車・ガソリン車の航続距離の比較を示す。

![Range of EV/HEV](range_ev.png)

ハイブリット自動車と電気自動車の航続距離の差は歴然である。
電気自動車は
ガソリン車と比較しても2倍以上の差があるのが現状である。
その燃費の良さから、ハイブリット自動車が最もポピュラーなエコ自動車として普及していること納得できる。

ガソリン車と電気自動車の航続距離にこれほど大きな差が出る原因はバッテリーのエネルギー密度にある。リチウムイオン電池のエネルギー密度は従来の2次電池と比べると高いが、
ガソリンには大きく及ばない。
ガソリンの体積エネルギー密度リチウムイオン電池の約20倍、
重量エネルギー密度は約50倍である。

ここで、Tesla Model SとNissan Leafの違いに触れる。
同じ電気自動車だが、航続距離が異なるのはバッテリー容量に差があるからである。

||航続距離[km]|バッテリ－容量[kWh]|電費[km/kWh]|
|:-----|:-----|:-----|:----|
|Tesla Model S|509|90|5.6|
|Nissan Leaf|280|30|9.3|

Model SはLeafの3倍の容量のバッテリーを積んでいる。
表に示すように電費を比較すると、Leafの方が優れていることがわかる。
航続距離を伸ばすために単純にバッテリーを多く積むことができないことが、
この例から容易に想像できる。
バッテリーの増加は重量増加・それに伴う効率低下・コスト増加を意味する。

電動航空機の分野では、バッテリー増加による効率の低下がより顕著に表れる。
空を飛ぶ航空機にとって機体重量は性能を大きく影響する設計値である。
推進器と燃料をバッテリーに変更するには航続距離とペイロードを大幅に犠牲にする必要がある。
図は電動航空機の成立性予測を示す。

![電気飛行機の成立性予測\cite{nomura2009}](seiritu.png)

この図からわかるように、
現状は小型航空機の実証段階である。
大型機の電動化には多くの技術的な課題が残る。
そのため、電動推進と燃焼推進を組み合わせるハイブリット型の構想等もある。

## 電動ビークルに関する研究動向

この節では、昨今の電動ビークルに関する分野における研究動向について紹介する。
電動ビークルに関する研究は、大きく分けて以下に挙げる3つの方向性である。

* エネルギー投入量を増やす
* バッテリー情報を正確に把握する
* 効率よく使う

何れも先に述べた航続距離が短い問題に取り組むものである。

### エネルギー投入量を増やす

航続距離が短い要因は実用的なバッテリー重量に対するエネルギーが小さいことである。
そのため、機体に投入するエネルギーを増やすことは、この問題に対する最も直接的な解である。
バッテリー自体のエネルギー密度向上に関する研究も多数あり、
新エネルギー・産業技術総合開発機構では、2次電池のエネルギー密度の2020年までの目標を現在の2倍以上に設定している\cite{nedo2013}。
その他の方法としては、エネルギー投入する機会を増やす、走行中にワイヤレス給電する手法\cite{小林大太2016走行中ワイヤレス給電システムにおけるリアルタイム最大効率制御}やバッテリ－を交換するステーションを設置する方法。\cite{Ure2015}
特に搭載されているバッテリーが小さいUAVに関しては、バッテリーを自動で交換する方式は効果的である。

### バッテリー情報を正確に把握する
この方向性は、バッテリーのエネルギー量を増やす働きをするわけではないが、
同じくらい重要な技術であるといえる。
バッテリーの情報を精度よく利用することで効果的な利用法が実現できる。

しかし、一般に電池の内部を正確に把握するのは困難である。
なぜなら、化学電池は一種の化学プラントであり、
内部の状態を表すパラメータは無数にあるためである。
ここで、電池のユーザーの視点に立つと、
必要な情報は充電率(State of Charge: SOC)や健全度(State of Health: SOH)
等の外部特性のみである。

この観点から従来は精度より利便性を重視してバッテリー状態が求められていた。

例えば、SOCの推定法について考える。
最も実用化されている手法として電流積算法がある。
これはその容易さから最も利用されているといえる。
以下に計算式を示す。
$$\mathrm{SOC}(t)=\mathrm{SOC}(t_0 )+\int_{t_0}^t i(\tau)d\tau$$

上式からからわかるように電流センサを搭載するのみで、SOCを求めることができる。
しかし、この手法では誤差を補正できないため、
精度が時間が立つにつれてどんどん大きくなってしまう欠点がある。
誤差の要因としては以下の4つが挙げられる。

* 初期値誤差
* 電流センサの誤差
* 電池の劣化による誤差
* 自己放電による誤差

この誤差の発生の課題を解決する手法として、
近年新しく構築された「モデル化に基づくバッテリー状態量推定法」}\cite{Ure2015}\cite{gregory2004extended}\cite{he2011state}\cite{baba2014soc}がある。
これについては2章で詳しく紹介する。
この手法では、以下の図のようなカルマンフィルタなどを組み込んだ状態推定器を構成することで、誤差を補正することを可能にしている。

![モデルに基づくバッテリー状態推定\cite{nomura2009}](model_based_est.png)

電気自動車やハイブリット自動車など充放電を高速に繰り返すなど激しい利用条件においても
効果を発揮することが示されている。

### 効率よく使う
限られたエネルギー容量を効率よく利用することは航続距離を延長することにつながる。
また、電動ビークルには、設計の自由度や回生充電など独自の長所が数多く存在するため、
航続距離が短いという短所をそれで補うことができる可能性が十分にある。

例えば、藤本らは近未来で想定される全輪駆動の電気自動車において、
モータの駆動力を各車輪に分配するすることで航続距離を延長できることを示した\cite{原田信吾2014電気自動車におけるスリップ率とモータ損失を考慮した前後輪制駆動力配分による加減速時の航続距離延長制御}。

逆に、現時点で電気自動車の長所をうまく活用できていないとも考えられる。
電気自動車独自のナビゲーションシステムへの応用を目標に
多くの最適経路問題に関する研究がなされている\cite{清水太朗2011道路勾配などを考慮した電気自動車の最適経路問題}\cite{木山昇2013航続可能距離と充電時間を考慮した電気自動車向けルート探索手法}\cite{瀬古沢照治2014電気自動車による最多点巡回問題と解法の提案}。

##　電動ビークルの軌道計画法とバッテリー状態量
この節では、軌道計画法においてバッテリー状態量がどのように利用されているかについて述べる。
前節にて触れたとおり電気自動車の軌道計画法の研究はナビへの応用として利用される。
例えば、道路勾配や充電時間を考慮したものなど、数多く存在する\cite{清水太朗2011道路勾配などを考慮した電気自動車の最適経路問題}\cite{木山昇2013航続可能距離と充電時間を考慮した電気自動車向けルート探索手法}。
また、2点間の最適経路問題のみではなく、瀬古沢らが示した最適巡回問題\cite{瀬古沢照治2014電気自動車による最多点巡回問題と解法の提案}など、
様々な考え方の軌道計画法が示されている。
しかし、最終的に運転手の判断に依存されていることもあり、
多くの近似が含まれている。
例えば、航続可能距離を常に電費と消費電力の積で算出する等である。

一方、ドローンの軌道計画法に関して言えば、
バッテリー状態量は電欠を防ぐためだけに利用されている。
iRobot RoombaやSoftbank Pepperのようなロボットにおいては、
バッテリーが切れそうになったら充電ステーションに自動で帰る機能が付加されている。
常にバッテリー状態量を生かして仕事を実行しているわけではなく、
活動限界時間をモニターするためだけに利用されている。

村井らの搬送ロボットのバッテリー状態量の利用法は\cite{村井亮介2010自律移動ロボット群による搬送システムの実用化}
の他とは少し異なり、
以下のような場合分けの条件で動く。  
レベル4　通常稼働  
レベル3　搬送作業が無ければ充電を行う  
レベル2　充電を優先して行う  
レベル1　ロボットの電源をOFFする  

しかし、こちらの方法もバッテリー状態量を軌道計画に利用しているわけではない．
このような手法が取られている背景には電流積算法によるSOC推定法の誤差が大きく、
あまりに活動限界時間をギリギリの条件にすると、
電欠するケースが頻出する可能性があったからだと思われる。
しかし、モデルに基づくSOC推定法では実利用上の最初から最後まで小さい誤差でバッテリー状態量を把握すること、それを効果的に利用できる可能を秘めている。

そこで、本研究の目的を

* モデルに基づくSOC推定法を組み込んだ軌道計画法の開発と実証

と定義する。
特に、バッテリーの情報をタスク実行に有効利用することと、
電欠に対するマージンを減らすことを重要視する。

#　モデルに基づくSOC推定法
## 非線形カルマンフィルタを用いた状態推定法

図のような3次のフォスター型回路を等価回路モデルに利用した電池モデルを考える。

![Battery model using tertialy Foster equivalent circuit](foster1.png)

このとき入力 $u(t)=i(t)$ 、
出力 $y(t)=v(t)$ とする。
ただし $i(t)$ は回路全体を流れる電流 $v(t)$ は回路全体の電圧降下を表す。

このとき状態空間表現は、

$$\frac{d}{dt}\boldsymbol{x}(t)=\boldsymbol{A} \boldsymbol{x}(t)+\boldsymbol{b} u(t)$$

$$\boldsymbol{x}(t)=[\mathrm{SOC}(t)~v_1(t)~v_2(t)~v_3(t)]^\mathrm{T}$$

$$y(t)=f_\mathrm{OCV} (\mathrm{SOC}(t))+[0~1~1~1]\boldsymbol{x}(t)+R_0 u(t)$$

$$\boldsymbol{A} = \mathrm{diag}\left(0~-\frac{1}{C_1 R_1}~-\frac{1}{C_2 R_2}~-\frac{1}{C_3 R_3}\right)$$

$$\boldsymbol{b}= \left[\frac{1}{\mathrm{FCC}}~\frac{1}{C_1}~\frac{1}{C_2}~\frac{1}{C_3}\right]^\mathrm{T}$$

$$C_l = \frac{C_d}{2},~R_l=\frac{8R_d}{(2l-1)^2 \pi^2},~l=1,2,3$$

$$\theta = [R_0~R_d~C_d~\mathrm{FCC}]^\mathrm{T}$$

![入出力データとSOC](io-data+SOC.jpg)

![電流積算法によるSOC推定結果](SOC_by_CC.jpg)

![EKFによるSOC推定結果(状態推定法),網掛け：推定分散($\pm 2\sigma$範囲)](SOC_by_EKF.jpg)

結果より、モデルに基づく推定法を利用すれば誤差を補正することができることがわかる。

## 対数化UKFを用いたSOCの状態とパラメータ(3つ)の同時推定法
パラメータを既知とする方法は使用条件が時々刻々と変化するEVやHEVでは使用条件が限られるため、状態推定法よりも同時推定法が好ましい。
近年の計算処理能力の向上からより複雑なモデルを非線形カルマンフィルタを利用した同時推定が実現されている。

### 理論式

*  UKF

拡大状態変数を
$$\boldsymbol{z}(t)= [\boldsymbol{x}^\mathrm{T}(t)~\boldsymbol{\theta}^\mathrm{T}(t)]^\mathrm{T}$$
のように定義する。
この電池モデルの未知パラメータは
$$\boldsymbol{\theta}(t)= [R_0(t)~R_d(t)~C_d(t)~\mathrm{FCC}]^\mathrm{T}$$
である。
このうち $\mathrm{FCC}$ のみ既知とする。
この時の状態空間表現は
$$\frac{d}{dt}\boldsymbol{z}(t)=\boldsymbol{A} \boldsymbol{z}(t)+\boldsymbol{b} u(t)$$
$$\boldsymbol{z}(t)=[\mathrm{SOC}(t)~v_1(t)~v_2(t)~v_3(t)~R_0(t)~R_d(t)~C_d(t)]^\mathrm{T}$$
$$y(t)=f_\mathrm{OCV} (\mathrm{SOC}(t))+[0~1~1~1~0~0~0]\boldsymbol{z}(t)+R_0(t) u(t)$$
$$\boldsymbol{A} = \mathrm{diag}\left(0~-\frac{1}{C_1 R_1}~-\frac{1}{C_2 R_2}~-\frac{1}{C_3 R_3}~0\right)$$
$$\boldsymbol{b}= \left[\frac{1}{\mathrm{FCC}}~\frac{1}{C_1}~\frac{1}{C_2}~\frac{1}{C_3}~0\right]^\mathrm{T}$$
$$C_l = \frac{C_d}{2},~R_l=\frac{8R_d}{(2l-1)^2 \pi^2},~l=1,2,3$$
となる。

*  対数化UKF

上のモデルの未知パラメータに対して対数をとった状態変数を
$$\boldsymbol{z_L}(t)= [\boldsymbol{x}^\mathrm{T}(t)~\boldsymbol{\theta_L}^\mathrm{T}(t)]^\mathrm{T}$$
とする
ただし、
$$\boldsymbol{\theta_L}(t)=[\alpha_{R_0}(t)~\alpha_{R_d}(t)~\alpha{C_d}(t)~\alpha_{\mathrm{FCC}}]^\mathrm{T}$$
$$= [\ln R_0(t)~\ln R_d(t)~\ln C_d(t)~\ln \mathrm{FCC}]^\mathrm{T}$$
である。

### 計算条件
入出力データを以下の図のように計測できたとする。

![Input output data and SOC true value](io-data+SOC.jpg)

各パラメータの真値を
$$\theta(0)=
\begin{bmatrix}
R_0\\
R_d\\
C_d\\
\end{bmatrix}
=
\begin{bmatrix}
0.45\times10^{-3}\\
0.50\times10^{-3}\\
8.2\times10^{4}\\
\end{bmatrix}
$$
とする。

UKFの設定値を以下に示す。
$$\boldsymbol{Q}=\mathrm{diag}(10^{-2},~10^{-6},~10^{-6},~10^{-6},~10^{-10},~10^{-10},~10^{4})$$
$$r=0.1$$
$$\boldsymbol{P}(0)=\mathrm{diag}(0.1,~10^{4},~10^{4},~10^{4},~10^{-6},~10^{-6},~10^{6})$$
$$\hat{z}(0)=
\begin{bmatrix}
91.49\\
0\\
0\\
0\\
0.47\times10^{-3}\\
0.52\times10^{-3}\\
8.0\times10^{4}
\end{bmatrix}$$

対数化UKFの設定値を以下に示す。
$$\boldsymbol{Q}=\mathrm{diag}(10^{-2},~10^{-6},~10^{-6},~10^{-6},~10^{-8},~10^{-8},~10^{-10})$$
$$r=0.1$$
$$\boldsymbol{P}(0)=\mathrm{diag}(0.1,~10^{4},~10^{4},~10^{4},~1,~1,~3)$$
$$\hat{z}(0)=
\begin{bmatrix}
91.49\\
0\\
0\\
0\\
\ln(0.47\times10^{-3})\\
\ln(0.52\times10^{-3})\\
\ln(8.0\times10^{4})
\end{bmatrix}$$

### 結果
![State estimation result by SOC simultaneous estimation method using UKF, shadow: estimation variance($\pm 2\sigma$)](160613simul_soc.jpg)

![Parameter estimation result by SOC simultaneous estimation method using UKF, shadow: estimation variance($\pm 2\sigma$)](160613simul_param.jpg)

![State estimation result by SOC simultaneous estimation method using logarithmic UKF, shadow: estimation variance($\pm 2\sigma$)](160613simul_soc_log.jpg)

![Parameter estimation result by SOC simultaneous estimation method using logarithmic UKF, shadow: estimation variance($\pm 2\sigma$)](160613simul_param_log.jpg)

対数化UKFによる推定結果の方がパラメータ全体にわたって精度よく推定できており、SOC推定結果の精度が高いことがわかる。

# 結論

* 電動ビークルの現状の課題について整理・抽出・定義した
    - モデルに基づくSOC推定法を組み込んだ軌道計画法の開発と実証

* モデルに基づくSOC推定法を構築した


# 今後の計画

|期間|内容|
|:--|:--|
|~16/07|軌道計画法のシミュレータを作る|
|~16/09|UAV電池(リチウムポリマ)のSOC推定手法を構築|
|~16/12|モデルに基づくSOC推定法を組み込んだ軌道計画シミュレータ、実験設計の終了(着地付近の運動)|
|~17/03|実験の有効性を判断、改良案の方向性を決める|
|17/04~|広範囲な運動に関する実験|
