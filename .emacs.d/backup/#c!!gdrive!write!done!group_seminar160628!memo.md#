# 先週のAI一覧
* 対数化UKFを用いたSOCの同時推定法

# 対数化UKFを用いたSOCの状態とパラメータ(3つ)の同時推定法
## 背景
パラメータを既知とする方法は使用条件が時々刻々と変化するEVやHEVでは使用条件が限られるため、状態推定法よりも同時推定法が好ましい。
近年の計算処理能力の向上からより複雑なモデルを非線形カルマンフィルタを利用した同時推定が実現されている。

## 目的
前回（第9回ミーティング資料）では3つのパラメータを推定可能にプログラムを構築したが、今回はパラメータのオーダーの違いによる桁落ちを防ぐ対数化UKFによる推定器を構築した。\cite{baba2013log_ukf}。

## 理論式
### UKF
図のような3次のフォスター型回路を等価回路モデルに利用した電池モデルを考える。

![Battery model using tertialy Foster equivalent circuit](foster1.png)

このとき入力 $u(t)=i(t)$ 、
出力 $y(t)=v(t)$ とする。
ただし $i(t)$ は回路全体を流れる電流 $v(t)$ は回路全体の電圧降下を表す。

拡大状態変数を
$$\boldsymbol{z}(t)= [\boldsymbol{x}^\mathrm{T}(t)~\boldsymbol{\theta}^\mathrm{T}(t)]^\mathrm{T}$$
のように定義する。
この電池モデルの未知パラメータは
$$\boldsymbol{\theta}(t)= [R_0(t)~R_d(t)~C_d(t)~\mathrm{FCC}]^\mathrm{T}$$
である。
このうち $\mathrm{FCC}$ のみ既知とする。
この時の状態空間表現は
$$\frac{d}{dt}\boldsymbol{z}(t)=\boldsymbol{A} \boldsymbol{z}(t)+\boldsymbol{b} u(t)$$
$$\boldsymbol{z}(t)=[\mathrm{SOC}(t)~v_1(t)~v_2(t)~v_3(t)~R_0(t)~R_d(t)~C_d(t)]^\mathrm{T}$$
$$y(t)=f_\mathrm{OCV} (\mathrm{SOC}(t))+[0~1~1~1~0~0~0]\boldsymbol{z}(t)+R_0(t) u(t)$$
$$\boldsymbol{A} = \mathrm{diag}\left(0~-\frac{1}{C_1 R_1}~-\frac{1}{C_2 R_2}~-\frac{1}{C_3 R_3}~0\right)$$
$$\boldsymbol{b}= \left[\frac{1}{\mathrm{FCC}}~\frac{1}{C_1}~\frac{1}{C_2}~\frac{1}{C_3}~0\right]^\mathrm{T}$$
$$C_l = \frac{C_d}{2},~R_l=\frac{8R_d}{(2l-1)^2 \pi^2},~l=1,2,3$$
となる。

### 対数化UKF
上のモデルの未知パラメータに対して対数をとった状態変数を
$$\boldsymbol{z_L}(t)= [\boldsymbol{x}^\mathrm{T}(t)~\boldsymbol{\theta_L}^\mathrm{T}(t)]^\mathrm{T}$$
とする
ただし、
$$\boldsymbol{\theta_L}(t)=[\alpha_{R_0}(t)~\alpha_{R_d}(t)~\alpha{C_d}(t)~\alpha_{\mathrm{FCC}}]^\mathrm{T}$$
$$= [\ln R_0(t)~\ln R_d(t)~\ln C_d(t)~\ln \mathrm{FCC}]^\mathrm{T}$$
である。

## 計算条件
入出力データを以下の図のように計測できたとする。

![Input output data and SOC true value](io-data+SOC.jpg)

各パラメータの真値を
$$\theta(0)=
\begin{bmatrix}
R_0\\
R_d\\
C_d\\
\end{bmatrix}
=
\begin{bmatrix}
0.45\times10^{-3}\\
0.50\times10^{-3}\\
8.2\times10^{4}\\
\end{bmatrix}
$$
とする。

UKFの設定値を以下に示す。
$$\boldsymbol{Q}=\mathrm{diag}(10^{-2},~10^{-6},~10^{-6},~10^{-6},~10^{-10},~10^{-10},~10^{4})$$
$$r=0.1$$
$$\boldsymbol{P}(0)=\mathrm{diag}(0.1,~10^{4},~10^{4},~10^{4},~10^{-6},~10^{-6},~10^{6})$$
$$\hat{z}(0)=
\begin{bmatrix}
91.49\\
0\\
0\\
0\\
0.47\times10^{-3}\\
0.52\times10^{-3}\\
8.0\times10^{4}
\end{bmatrix}$$

対数化UKFの設定値を以下に示す。
$$\boldsymbol{Q}=\mathrm{diag}(10^{-2},~10^{-6},~10^{-6},~10^{-6},~10^{-8},~10^{-8},~10^{-10})$$
$$r=0.1$$
$$\boldsymbol{P}(0)=\mathrm{diag}(0.1,~10^{4},~10^{4},~10^{4},~1,~1,~3)$$
$$\hat{z}(0)=
\begin{bmatrix}
91.49\\
0\\
0\\
0\\
\ln(0.47\times10^{-3})\\
\ln(0.52\times10^{-3})\\
\ln(8.0\times10^{4})
\end{bmatrix}$$

## 結果
![State estimation result by SOC simultaneous estimation method using UKF, shadow: estimation variance($\pm 2\sigma$)](160613simul_soc.jpg)

![Parameter estimation result by SOC simultaneous estimation method using UKF, shadow: estimation variance($\pm 2\sigma$)](160613simul_param.jpg)

![State estimation result by SOC simultaneous estimation method using logarithmic UKF, shadow: estimation variance($\pm 2\sigma$)](160613simul_soc_log.jpg)

![Parameter estimation result by SOC simultaneous estimation method using logarithmic UKF, shadow: estimation variance($\pm 2\sigma$)](160613simul_param_log.jpg)

対数化UKFによる推定結果の方がパラメータ全体にわたって精度よく推定できており、SOC推定結果の精度が高いことがわかる。

# 今週のAI計画
* 走行ロボットの経路計画法の文献調査と実装
    - 最近のEV軌道計画法の文献の調査
